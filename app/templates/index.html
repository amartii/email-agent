{% extends "base.html" %}
{% block title %}Email Agent — Cargar Excel{% endblock %}
{% block step1_active %}active{% endblock %}

{% block content %}
<div class="oto-wizard-header">
    <h1 class="oto-page-title">Cargar lista de contactos</h1>
    <p class="oto-page-subtitle">Sube tu fichero Excel con los contactos de la campaña. El agente detectará las columnas automáticamente.</p>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>Fichero Excel
            </div>
            <div class="card-body p-4">
                <form id="uploadForm">
                    <div class="oto-dropzone mb-3" id="dropzone" onclick="document.getElementById('excelFile').click()">
                        <div class="oto-dropzone-icon"><i class="bi bi-cloud-upload"></i></div>
                        <div class="oto-dropzone-text">
                            Arrastra tu fichero aquí o <strong style="color:var(--oto-blue)">haz clic para seleccionar</strong>
                        </div>
                        <div class="text-muted small">.xlsx · .xls · máx. 10 MB</div>
                        <input type="file" id="excelFile" name="file" accept=".xlsx,.xls" class="d-none" required>
                    </div>
                    <div id="fileName" class="oto-info-pill d-none mb-3">
                        <i class="bi bi-file-check"></i><span id="fileNameText"></span>
                    </div>
                    <button type="submit" class="btn btn-oto-primary w-100" id="btnUpload">
                        <i class="bi bi-search me-2"></i>Detectar columnas
                    </button>
                </form>

                <div id="columnMapping" class="d-none mt-4">
                    <div class="oto-divider"></div>
                    <p class="form-label mb-3">Mapear columnas</p>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Columna Nombre</label>
                            <select id="nameCol" class="form-select"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Columna Email</label>
                            <select id="emailCol" class="form-select"></select>
                        </div>
                    </div>
                    <div id="colPreview" class="oto-info-pill mb-4">
                        <i class="bi bi-info-circle"></i>
                        <span id="colPreviewText"></span>
                    </div>
                    <button class="btn btn-oto-primary w-100" id="btnNext">
                        Continuar a configuración <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-info-circle me-2"></i>Columnas gestionadas</div>
            <div class="card-body p-3">
                <p class="text-muted small mb-3">El agente añade automáticamente estas columnas a tu Excel:</p>
                <ul class="list-unstyled small">
                    <li class="mb-2"><span class="badge-status badge-sent me-2">Estado</span> Estado del envío</li>
                    <li class="mb-2"><span class="badge-status badge-pending me-2">Fecha Envío</span> Cuándo se envió</li>
                    <li class="mb-2"><span class="badge-status badge-replied me-2">Respondido</span> Fecha de respuesta</li>
                    <li class="mb-2"><span class="badge-status badge-followup_sent me-2">Follow-up</span> Seguimiento enviado</li>
                </ul>
                <div class="oto-divider"></div>
                <p class="text-muted small mb-0">Usa <strong>{{NombreColumna}}</strong> en tus plantillas para personalizar los correos.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dz = document.getElementById('dropzone');
const fi = document.getElementById('excelFile');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dragover');
    if (e.dataTransfer.files[0]) { fi.files = e.dataTransfer.files; updateFileName(); }
});
fi.addEventListener('change', updateFileName);
function updateFileName() {
    const f = fi.files[0];
    if (!f) return;
    document.getElementById('fileNameText').textContent = f.name;
    document.getElementById('fileName').classList.remove('d-none');
}
</script>
{% endblock %}
